---
title: Preparing for TLS
owner: MySQL
---

<strong><%= modified_date %></strong>

This topic describes how to provide an existing CA certificate to BOSH CredHub
and how to generate a new CA certificate with BOSH CredHub, if you do not already have one.

<p class="note warning"><strong>WARNING</strong>: This procedure involves restarting
	all of the VMs in your PCF deployment in order to apply a CA certificate. The
	operation can take a long time to complete.</p>

##<a id='overview'></a> Overview

Enabling TLS provisions a MySQL server with a certificate so that apps and
clients can establish an encrypted connection with the data service.

The certificate deployed with the MySQL server is a **server certificate**.
The server certificate is generated by **CredHub**, a component designed for
centralized credential management in PCF,
colocated on the BOSH Director.

CredHub generates the server certificate with a **Certificate Authority (CA) certificate**.
The CA certificate must be provided to CredHub by the operator or generated by CredHub.

Apps and clients use the public component of the CA certificate to validate that
a server certificate has been generated by a known, trusted CA.
Apps and clients that communicate with the MySQL server must have access to the
public component of the CA certificate
in order to validate that the server certificate can be trusted.

PCF distributes the public component of the CA certificate to apps in two ways:

* PCF provisions a copy of the CA certificate in the trusted store of each
container's operating system.
  Apps written in Java and Spring automatically discover the CA certificate in
	the trusted store.
* PCF supplies the public CA certificate in an environment variable called
`VCAP_SERVICES` that exists in every container.
  Apps not written in Java and Spring can retrieve the public component of the
	CA certificate from `VCAP_SERVICES`
  and use it to establish an encrypted connection with the data service.

##<a id='workflow'></a> Workflow

The following workflow describes enabling TLS for MySQL for PCF:

<ol>
<li>An operator provides a CA certificate to CredHub by performing the procedures
	in <a href="#provide-generate-pcf">Provide or Generate a CA Certificate</a> below.</li>
<li>An operator enables TLS in the tile configuration while installing MySQL for PCF.
    See <a href="install-config.html#security">Configure Security</a>.</li>
<li>A developer enables TLS for an existing service instance.
    See <a href="using-tls.html#enable-tls">Enable TLS</a>.</li>
<li>A developer modifies their app to communicate securely with the MySQL server:
    <ul><li>For Java and Spring apps, see
			<a href="using-tls.html#activate-spring">Activate TLS for Java and Spring Apps</a>.</li>
    <li>For all other apps, see <a href="using-tls.html#activate-non-spring">Activate TLS for Non-Spring Apps</a>.</li>
</li>
</ol>

<p class="note"><strong>Note</strong>: An operator must also rotate the CA
	certificate if it expires or if it becomes compromised.
For information on how to rotate your CA certificate, see
<a href="rotating-ca.html">Rotating CA Certificates</a>.</p>

##<a id="provide-generate-pcf"></a> Generate and Add a CA Certificate

Follow the procedures below to generate and add a CA certificate.


###<a id='credhub-creds'></a> Find the CredHub Credentials in Ops Manager

You need the BOSH CredHub client name and client secret to complete the
[Add the CA Certificate](#add-ca-cert) procedure below.

To find the BOSH CredHub client name and client secret, do the following:

1. In the Ops Manager Installation Dashboard, click the BOSH Director tile.
1. Click the **Credentials** tab.
1. In the BOSH Director section, click the link to the BOSH Commandline Credentials.
	![CredHub Credentials](credhub-creds.png)
1. Record the values for `BOSH_CLIENT` and `BOSH_CLIENT_SECRET`.


	Here is an example of the credentials page:

	```
	{"credential":"BOSH_CLIENT=ops_manager
	BOSH_CLIENT_SECRET=abCdE1FgHIjkL2m3n-3PqrsT4EUVwXy5
	BOSH_CA_CERT=/var/tempest/workspaces/default/root_ca_certificate
	BOSH_ENVIRONMENT=10.0.0.5 bosh "}
	```

  The `BOSH_CLIENT` is the BOSH CredHub client name and the `BOSH_CLIENT_SECRET` is
	the BOSH CredHub client secret.


###<a id='add-ca-cert'></a> Add the CA Certificate

<!-- UPDATE PROCEDURE -->

To generate and add the CA Certificate to Ops Manager, do the following:

1. From the Ops Manager VM, set the API target of the CredHub CLI to your BOSH
CredHub server.
    <br><br>
    Run the following command:

    ```
    credhub api https://BOSH-DIRECTOR:8844 --ca-cert=/var/tempest/workspaces/default/root_ca_certificate
    ```
    <br>
    Where `BOSH-DIRECTOR` is the IP address of the BOSH Director VM.
    <br><br>
    For example:
    <pre class="terminal">
    $ credhub api http<span>s:</span>//10.0.0.5:8844 --ca-cert=/var/tempest/workspaces/default/root_ca_certificate
    </pre>

1. Log in to CredHub.
    <br><br>
    Run the following command:

    ```
    credhub login --client-name=CREDHUB-CLIENT-NAME --client-secret=CREDHUB-CLIENT-SECRET
    ```
    Where:<br>
    * `CREDHUB-CLIENT-NAME` is the value you recorded for `BOSH_CLIENT` in
		[Find the CredHub Credentials](#credhub-creds) above.
    * `CREDHUB-CLIENT-SECRET` is the value you recorded for `BOSH_CLIENT_SECRET` in
		[Find the CredHub Credentials](#credhub-creds) above.
    <br><br>
    For example:
    <pre class="terminal">
    $ credhub login \
    	--client-name=credhub \
    	--client-secret=abcdefghijklm123456789
    </pre>
1. Use the CredHub CLI to check whether a services CA certificate already is present.
	<br><br>
	 Run following command:

  	```
  	credhub get --name="/services/tls_ca"
  	```
  If you already have a certificate at the `services/tls_ca` path, skip step 4.

1. Use the CredHub CLI to generate a CA certificate or provide an existing one.
    <p class="note"><strong>Note</strong>: Your PCF deployment may have
			multiple CA certificates.
       Pivotal recommends a dedicated CA certificate for services.</p>
	* If you do not have a CA certificate, use the CredHub CLI to generate one.
          Enter the following command:
		<pre class="terminal">
		$ credhub generate \
			--name="/services/tls_ca" \
			--type="certificate" \
			--is-ca \
            --common-name="rootCA"
		</pre>
    * If you have an existing CA certificate that you want to use, create
		a new file called `root.pem` with the contents of the certificate.
      Then enter the following command, specifying the path to `root.pem` and
			the private key for the certificate:
        <pre class="terminal">
        $ credhub set \
            --name="/services/tls_ca" \
            --type="certificate" \
            --certificate=./root.pem \
            --private=ERKSOSMFF...
        </pre>

1. Use the BOSH CLI v2 to extract the `certificate` portion from the CA certificate and print it.
    Run the following command:

    ```
    bosh2 int <(credhub get \
    --name=/services/tls_ca) \
    --path /value/certificate
    ```
1. Copy the output.
1. Navigate to the Ops Manager **Installation Dashboard** and select the Ops Manager Director tile.
Click **Security**.
1. Paste the contents of the CA certificate into **Trusted Certificates** and
 click **Save**.
1. After preparing your environment for TLS, you must enable TLS in the tile
configuration while installing MySQL for PCF:
    * **Existing Installation**: If you have already installed the MySQL for PCF
		tile, perform the procedures
    in [Configure TLS](install-config.html#tls) to enable TLS in the **Security**
		section of the tile.
    Then return to the Ops Manager Installation Dashboard to apply changes:
        1. If you are using Ops Manager v2.3 or later, click **Review Pending Changes**.
        For more information about this Ops Manager page, see
        [Reviewing Pending Product Changes](https://docs.pivotal.io/pivotalcf/customizing/review-pending-changes.html).<br><br>
        1. Click **Apply Changes**.

        This restarts all the VMs in your PCF deployment and applies your
				CA certificate.<br><br>
    * **New Installation**: If you have not yet installed the MySQL for PCF tile,
		perform all of
    the procedures in [Installing and Configuring MySQL for PCF](install-config.html).
    Then return to the Ops Manager Installation Dashboard to apply changes:
        1. If you are using Ops Manager v2.3 or later, click **Review Pending Changes**.
        For more information about this Ops Manager page, see
        [Reviewing Pending Product Changes](https://docs.pivotal.io/pivotalcf/customizing/review-pending-changes.html).<br><br>
        1. Click **Apply Changes**.

        This deploys MySQL for PCF, restarts all the VMs in your PCF deployment,
        and applies your CA certificate.
        <p class="note warning"><strong>WARNING</strong>: Restarting all of the
					VMs in your PCF deployment in order to apply a CA certificate takes a
					long time to complete.</p>
