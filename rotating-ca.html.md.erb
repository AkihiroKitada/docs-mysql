---
title: Rotating CA Certificates
owner: MySQL
---

This topic describes how to rotate CA certificates in BOSH CredHub. If you are using TLS for MySQL for PCF, you provided a CA certificate to CredHub as part of preparing your environment.

For more information about providing CA certificates to CredHub, see [Preparing for TLS](prepare-tls.html).

You may need to rotate the CA certificate if it expires or it is compromised.

##<a id='new-ca'></a> Step 1: Add New CA Certificate

Perform the following steps to add a new CA certificate to CredHub:

1. Perform the steps in [Gather Credential and IP Address Information](https://docs.pivotal.io/pivotalcf/2-0/customizing/trouble-advanced.html) and [SSH into Ops Manager of Advanced Troubleshooting with the BOSH CLI](https://docs.pivotal.io/pivotalcf/2-0/customizing/trouble-advanced.html) to SSH into the Ops Manager VM.
1. Create a new CA certificate at the path `/services/tls_ca_new`: 
    * If you already have a CA certificate, create a new file called `root.pem` with the contents of the certificate. Then enter the following command, specifying the path to `root.pem` and the private key for the certificate:
        <pre class="terminal">
        $ credhub set \
            --name="/services/tls_ca" \
            --type="certificate" \
            --certificate=./root.pem \
            --private=ERKSOSMFF...
        </pre>
	* If you do not have a CA certificate, use the CredHub CLI to generate one. Enter the following command:
		<pre class="terminal">
		$ credhub generate \
			--name "/services/tls_ca_new" \
			--type "certificate" \
			--is-ca --common-name="rootCA"
		</pre>

1. From the output, copy the `certificate` portion.
1. Navigate to the Ops Manager Installation Dashboard and click the **Ops Manager Director** tile.
1. Click **Security**.
1. Append the contents of the new root certificate to the old root certificate under **Trusted Certificates**. 
Do not remove the old root certificate.
1. Click **Save**.
1. Return to the Ops Manager Installation Dashboard and click **Apply Changes**. 
This will roll all the VMs in your PCF deployment, and apply your root certificate.

##<a id='regenerate'></a> Step 2: Regenerate Certificates and Redeploy Service Instances

Perform the following steps to regenerate your certificates and redeploy your service instances:

1. Log in to CredHub with the CredHub CLI, using the client name and client secret from [Preparing for TLS](prepare-tls.html). For example:
    <pre class="terminal">
    $ credhub login \
    	--client-name=credhub \
    	--client-secret=abcdefghijklm123456789
    </pre>
1. Use `curl` to make a call to the CredHub API to bulk regenerate all certificates signed by the old CA certificate.
 Specify the IP address of your BOSH Director VM, which you retrieved in [Preparing for TLS](prepare-tls.html). 
 For example:
	<pre class="terminal">
	$ curl "http<span>s:</span>//10.0.0.5/api/v1/bulk-regenerate" \
	    -X POST \
	    -d '{
	      "signed_by": "/services/tls_ca"
	     }' \
	    -H "authorization: bearer $(credhub --token)" \
	    -H 'content-type: application/json'
	</pre>

1. Perform the steps in [Log in to the BOSH Director](https://docs.pivotal.io/pivotalcf/2-0/customizing/trouble-advanced.html#log-in) to log in to the BOSH Director from the Ops Manager VM.
1. Run the `upgrade-all-service-instances` errand on the MySQL for PCF deployment to redeploy all service instances with the new certificates. Enter the following command, specifying the name of the BOSH deployment for MySQL for PCF: 
	<pre class="terminal">
	$ bosh2 -d p-mysql run-errand upgrade-all-service-instances
	</pre>
	<p class="note"><strong>Note</strong>: If you do not know the name of your MySQL for PCF deployment, run <code>bosh2 -e my-env deployments</code> to list deployments.</p>
1. All bound apps that do not validate server certificates using the trusted store must be re-bound to the MySQL for PCF service in order to receive the updated CA public key. This includes all apps that are neither Java nor Spring. Until these apps have been re-bound, they will not be able to reconnect to the MySQL for PCF service.

##<a id='remove-old-ca'></a> Step 3: Remove Old CA Certificate

After all applications are able to reconnect to service instances with server certificates that have been generated by the new CA, you may remove the old CA certificate.

Perform the following steps:

1. From the Ops Manager VM, use the CredHub CLI to remove the old CA certificate at `/services/tls_ca`. Enter the following command:
	<pre class="terminal">
	$ credhub delete --name '/services/tls_ca'
	</p>
1. Navigate to the Ops Manager Installation Dashboard and click the **Ops Manager Director** tile.
1. Click **Security**.
1. Delete the old root certificate in **Trusted Certificates** and click **Save**. 
1. Return to the Ops Manager Installation Dashboard and click **Apply Changes**. This will roll all the VMs in your PCF deployment.
