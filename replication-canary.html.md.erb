---
title:  Replication Canary (HA Cluster)
owner: MySQL
---

<strong><%= modified_date %></strong>

<%= partial "./galera_beta" %>

This topic describes  replication canary and how to enable it. 

MySQL for Pivotal Cloud Foundry (PCF) highly available (HA) clusters use replication to provide benefits such as quick failover and rolling upgrades. The replication canary monitors an HA cluster to ensure that replication is working. 

<%# MENTION JUMPBOX VM SOMEWHERE %>

## <a id="overview"></a>Overview

The replication canary writes to a private dataset in the cluster and then attempts to read the written 
data from each node. It pauses between reds and writes to ensure that the write-sets have been replicated. 
The private dataset does not use a significant amount of disk capacity.

When replication fails, the canary cannot read the data from all the nodes and does the 
following:

  - Sends a message that replication has failed to a configured email address. 
  See [Sample Notification Email](#sample-canary) below.
  - Disables client access to the cluster. See [Monitor Cluster Access](#access).

  <p class='note warning'><strong>Warning:</strong> When replication fails, data can be lost. Because of this, both of the above behaviors are enabled by default. Contact <a href="https://support.pivotal.io">Pivotal Support</a> immediately in the case of replication failure.</p>

## <a name="sample-canary"></a>Sample Notification Email

<%# IS THE NOTIFICATION SERVICE A THING? %> 

If the canary detects replication failure, it immediately sends an email through the 
Pivotal Application Service (PAS) notification service.

For example:

```
Subject: CF Notification: p-mysql Replication Canary, alert 417

This message was sent directly to your email address.

{alert-code 417}
This is an email to notify you that the MySQL service's replication canary 
has detected an unsafe cluster condition in which replication is not 
performing as expected across all nodes.
```

## <a name="access"></a> Monitor Cluster Access

When the canary detects replication failure, it disables connections to the database cluster through the proxies. When replication issue resolves, the canary automatically restores client access to the cluster.

If you must restore client access to the cluster while replication is failing, contact 
[Pivotal Support](https://support.pivotal.io).


You can determine if the canary disabled cluster access using the Switchboard API. For more information
about the Switchboard API, see [Monitor Node Health Using the API](./monitor-health.html#proxy-api).

To monitor cluster access, do the following:

1. Do the prerequisite procedure in [Monitor Node Health](monitor-health.html#monitor).

1. To monitor cluster access, run the following command:

    ```
    curl https://USERNAME:PASSWORD@N-HOSTNAME/v0/cluster
    ```
    
    Where:
    + `USERNAME` is the `username` you recorded in step 1.
    + `PASSWORD` is the `password` you recorded in step 1.
    + `N` is either 0, 1, or 2 depending on the proxy you want to connect to.
    + `HOSTNAME` is the `hostname` you recorded in step 1.
        
    For example:
    <pre class="terminal">
    $ curl https&#58;//abcdefghijklmno&#58;012345678912345&#64;0-proxy&#46;123abc45-67d8-912e-34f5-g34612c10dba.org.dedicated-mysql.cf-app.com/v0/cluster       
    [
      {
        "currentBackendIndex":0,
        "trafficEnabled":false,
        "message":"Disabling cluster traffic",
        "lastUpdated":"2016-07-27T05:16:29.197754077Z"
      }
    ]
    </pre>
    
    When cluster access is disabled, `trafficEnabled` is set to false.


## <a name="enable-canary"></a>Enable the Replication Canary

To enable the replication canary, follow the instructions below to configure PAS and the MySQL for PCF.

### <a name="configure-pas"></a>Configure PAS 

<p class="note"><strong>Note:</strong> In a typical PCF deployment, these settings are already configured.
</p>
1. In the **SMTP Config** section, enter a **From Email** that the replication canary can use to send notifications, along with the SMTP server configuration.
1. In the **Errands** section, select the **Notifications** errand.


### <a name="configure-mysql"></a>Configure the MySQL for PCF 

1. In the **Advanced Options** section, select **Enable replication canary**.
    <%#[Enable Replication](enable-replication.png) %>
1. If you want to the replication canary to send email but not disable access at the proxy, select **Notify only**.
  <p class="note"><strong>Note</strong>: Pivotal recommends leaving this checkbox unselected due to the possibility of data loss from replication failure.</p>
1. You can override the **Replication canary time period**. The **Replication canary time period** sets how frequently the canary checks for replication failure, in seconds. This adds a small amount of load to the databases, but the canary reacts more quickly to replication failure. The default is 30 seconds.

    <%# ![Canary time](canary_time.png) %>

1. You can override the **Replication canary read delay**. The **Replication canary read delay** sets how long the canary waits to verify data is replicating across each MySQL node, in seconds. Clusters under heavy load experience some small replication lag as writesets are committed across the nodes. The default is 20 seconds.
1. Enter an **Email address** to receive monitoring notifications. Use a closely monitored email address account. The purpose of the canary is to escalate replication failure as quickly as possible.
1. In the **Resource Config** section, ensure the **Monitoring** job has one instance.
  <%# [Resource config](monitoring-resource-config.png) %>
